# Creates a Persistent VM

resources:
- type: compute.v1.disk
  name: disk-{{ env["deployment"] }}-data
  properties:
    sizeGb: 30
    zone: {{ properties["zone"] }}
- type: compute.v1.instance
  name: vm-ds-{{ env["deployment"] }}
  properties:
    zone: {{ properties["zone"] }}
    # Note the machineType definition at the end. custom-4-5120 specifies 4 CPUs and 5GB (5120 MB) of RAM
    machineType: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/zones/{{ properties["zone"] }}/machineTypes/{{ properties["machinetype"] }}
    labels:
      vm-type: 'ai-user-work-vm'
    metadata:
      items:
      - key: enable-oslogin
        value: |
          TRUE
      - key: enable-oslogin-2fa
        value: |
          TRUE
      - key: startup-script
        value: |
          #!/bin/bash
          yum install -y {{ properties["packages"] }}

    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      diskEncryptionKey:
        kmsKeyName: "projects/{{ env["project"] }}/locations/global/keyRings/one_ring_to_rule_them_all/cryptoKeys/my_precious"
        #kmsKeyName: "projects/{{ env["project"] }}/locations/global/keyRings/{{ env["keyring"] }}/cryptoKeys/{{ env["cryptokey"] }}"
      initializeParams:
        diskName: disk-{{ env["deployment"] }}
        sourceImage: "projects/tj4h-project2/global/images/ds-vm-centos7-xrdp"
        #https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/family/debian-9
    - deviceName: disk-{{ env["deployment"] }}-data
      boot: false
      autoDelete: true
      source: $(ref.disk-{{ env["deployment"] }}-data.selfLink)
    networkInterfaces:
    #- network: https://www.googleapis.com/compute/v1/projects/tj4h-shared-services/global/networks/tj4h-shared-services-xpn1
    - subnetwork: https://www.googleapis.com/compute/v1/projects/tj4h-shared-services/regions/northamerica-northeast1/subnetworks/{{ properties["subnetwork"] }}

      # Access Config required to give the instance a public IP address
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT

# Declare outputs here
outputs:
- name: cliCommand
  description: YOUR LOGIN INFO
  value: gcloud beta compute ssh vm-ds-{{ env["deployment"] }} --internal-ip --zone {{ properties["zone"] }} -- -L 2222:localhost:3389
